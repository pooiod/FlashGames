<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Loader</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #000;
            color: #fff;
            overflow: hidden;
            height: 100vh;
        }
        #loading-screen, #offline-screen, #file-input-container {
            display: none;
            align-items: center;
            justify-content: center;
            height: 100vh;
            text-align: center;
        }
        #progress-bar {
            width: 100%;
            background-color: #444;
            height: 1rem;
            margin-top: 1rem;
        }
        #progress-bar > div {
            height: 100%;
            background-color: #0f0;
            width: 0;
            transition: width 0.2s;
        }
        #download-button, #file-input-container {
            display: flex;
            justify-content: center;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div id="loading-screen">
        <h1>Preparing game files...</h1>
        <div id="progress-bar"><div></div></div>
    </div>
    <div id="offline-screen">
        <h1>The game failed to download</h1>
        <p>Please ensure you have an active internet connection or try again later.</p>
    </div>
    <div id="file-input-container">
        <input type="file" id="file-input" accept=".swf">
    </div>
    <button id="download-button">Download [gamename]</button>
    <script>
        try {
            var getGameFromUrl = async function() {
                var urlParams = new URLSearchParams(window.location.search);
                var gameName = urlParams.get('game');
                if (!gameName) {
                    document.getElementById('file-input-container').style.display = 'flex';
                    document.getElementById('loading-screen').style.display = 'none';
                    return;
                }
                document.title = "Download " + gameName;

                var loadingScreen = document.getElementById('loading-screen');
                var progressBar = document.getElementById('progress-bar').firstElementChild;
                var downloadButton = document.getElementById('download-button');
                var offlineScreen = document.getElementById('offline-screen');

                loadingScreen.style.display = 'flex';
                offlineScreen.style.display = 'none';
                downloadButton.style.display = 'none';

                var response = await fetch('games/' + gameName + '.swf');
                if (!response.ok) {
                    loadingScreen.style.display = 'none';
                    document.getElementById('offline-screen').style.display = 'block';
                    return;
                }

                var reader = response.body.getReader();
                var contentLength = +response.headers.get('Content-Length');
                var receivedLength = 0;
                var chunks = [];

                while (true) {
                    var result = await reader.read();
                    if (result.done) break;
                    chunks.push(result.value);
                    receivedLength += result.value.length;
                    progressBar.style.width = (receivedLength / contentLength * 100) + '%';
                    progressBar.textContent = Math.round(receivedLength / contentLength * 100) + '%';
                }

                var arrayBuffer = new Uint8Array(await new Response(new Blob(chunks)).arrayBuffer());
                var base64 = btoa(
                    arrayBuffer.reduce(function(data, byte) {
                        return data + String.fromCharCode(byte);
                    }, '')
                );
                var dataUri = 'data:application/x-shockwave-flash;base64,' + base64;

                var downloadHtml = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${gameName}</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #000;
            color: #fff;
            overflow: hidden;
            height: 100vh;
        }
    </style>
</head>
<body>
    <object type="application/x-shockwave-flash" data="${dataUri}" width="100%" height="100%"></object>
</body>
</html>
`;
                var blob = new Blob([downloadHtml], { type: 'text/html' });
                var url = URL.createObjectURL(blob);
                document.getElementById('download-button').href = url;
                document.getElementById('download-button').download = gameName + '.html';
                document.getElementById('download-button').style.display = 'block';
                loadingScreen.style.opacity = 0;
                setTimeout(function() {
                    loadingScreen.style.display = 'none';
                    document.getElementById('download-button').style.opacity = 1;
                }, 500);
            };

            var fileInput = document.getElementById('file-input');
            fileInput.addEventListener('change', function(event) {
                var file = event.target.files[0];
                if (file) {
                    var reader = new FileReader();
                    reader.onload = function() {
                        var dataUri = 'data:application/x-shockwave-flash;base64,' + btoa(
                            new Uint8Array(reader.result).reduce(function(data, byte) {
                                return data + String.fromCharCode(byte);
                            }, '')
                        );
                        var downloadHtml = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Game</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #000;
            color: #fff;
            overflow: hidden;
            height: 100vh;
        }
    </style>
</head>
<body>
    <object type="application/x-shockwave-flash" data="${dataUri}" width="100%" height="100%"></object>
</body>
</html>
`;
                        var blob = new Blob([downloadHtml], { type: 'text/html' });
                        var url = URL.createObjectURL(blob);
                        var downloadButton = document.getElementById('download-button');
                        downloadButton.href = url;
                        downloadButton.download = 'local-game.html';
                        downloadButton.textContent = 'Download Local Game';
                        downloadButton.style.display = 'block';
                    };
                    reader.readAsArrayBuffer(file);
                } else {
                    alert('Please select a valid .swf file');
                }
            });

            getGameFromUrl();
        } catch (error) {
            console.error('Error:', error);
        }
    </script>
</body>
</html>
